<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>后台管理</title>
    <link rel="stylesheet" href="files/bootstrap.min.css">
    <link rel="stylesheet" href="files/bootstrap-select.min.css">
    <link rel="stylesheet" href="files/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">后台管理</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active"><a class="nav-link" href="/admin/">站点配置</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin/editor/">新建文章</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin/manage-posts/">文章管理</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin/comments.html">评论管理</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <h2>站点配置</h2>
        <form id="config-form">
            <div class="form-group">
                <label>菜单 (WidgetMenu)</label>
                <div id="menu-editor" class="menu-editor">
                    <ul id="menu-list" class="list-group">
                        </ul>
                    <button type="button" id="add-menu-item" class="btn btn-secondary btn-sm mt-2">+ 添加一级菜单</button>
                </div>
                <textarea name="WidgetMenu" id="WidgetMenu" style="display: none;">{{widgetMenuList}}</textarea>
            </div>
            
            <script type="text/template" id="menu-item-template">
                <li class="list-group-item" data-id="{id}">
                    <div class="menu-item-row">
                        <span class="handle">☰</span>
                        <input type="text" class="form-control menu-name" placeholder="菜单名" value="{name}">
                        <input type="text" class="form-control menu-url" placeholder="链接" value="{url}">
                        <input type="text" class="form-control menu-icon" placeholder="图标 (例如 fa fa-home)" value="{icon}">
                        <button type="button" class="btn btn-danger btn-sm remove-menu-item">删除</button>
                    </div>
                    <ul class="list-group sub-menu-list">
                        </ul>
                    <button type="button" class="btn btn-info btn-sm add-sub-menu-item mt-1">+ 添加二级菜单</button>
                </li>
            </script>
            <div class="form-group">
                <label for="WidgetCategory">分类 (WidgetCategory)</label>
                <textarea class="form-control" id="WidgetCategory" name="WidgetCategory" rows="5">{{widgetCategoryList}}</textarea>
            </div>
            <div class="form-group">
                <label for="WidgetLink">友链 (WidgetLink)</label>
                <textarea class="form-control" id="WidgetLink" name="WidgetLink" rows="5">{{widgetLinkList}}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">保存配置</button>
        </form>
        <hr>
        <h2>数据管理</h2>
        <div class="mt-2">
            <button id="export-btn" class="btn btn-info">导出数据</button>
            <button id="import-btn" class="btn btn-warning">导入数据</button>
            <button id="publish-btn" class="btn btn-success">清除缓存</button>
        </div>
        <textarea id="import-export-data" class="form-control mt-2" rows="10"></textarea>
    </div>
    <script src="files/jquery.min.js"></script>
    <script src="files/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            // 保存配置
            $('#config-form').submit(function(e) {
                e.preventDefault();
                var formData = $(this).serializeArray();
                $.ajax({
                    url: '/admin/saveConfig/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert('配置已保存！');
                    },
                    error: function() {
                        alert('保存失败，请检查登录状态或联系管理员。');
                    }
                });
            });

            // 导出数据
            $('#export-btn').click(function() {
                $.get('/admin/export/', function(data) {
                    $('#import-export-data').val(JSON.stringify(data, null, 2));
                    alert('数据已导出到文本框！');
                });
            });

            // 导入数据
            $('#import-btn').click(function() {
                var dataStr = $('#import-export-data').val();
                if (dataStr && confirm('确定要导入数据吗？这将覆盖现有数据！')) {
                    try {
                        var jsonData = JSON.parse(dataStr);
                         $.ajax({
                            url: '/admin/import/',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify([{ name: 'importJson', value: dataStr }]),
                            success: function(response) {
                                alert('数据导入成功！');
                                location.reload();
                            },
                             error: function() {
                                alert('导入失败！');
                            }
                        });
                    } catch (e) {
                        alert('导入失败，JSON格式错误！');
                    }
                }
            });
            
            // 清除缓存
            $('#publish-btn').click(function() {
                if(confirm('确定要清除全站缓存吗？')){
                    $.post('/admin/publish/', function(data) {
                        if(data.msg === 'OK'){
                             alert('缓存已清除！');
                        }
                    });
                }
            });
        });
    </script>
    <script>
    $(document).ready(function() {
        // --- New Menu Editor Logic ---
        const menuList = $('#menu-list');
        const menuDataTextarea = $('#WidgetMenu');
        const template = $('#menu-item-template').html();

        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        function renderMenuItem(item, isSub=false) {
            let itemHtml = template
                .replace(/{id}/g, item.id || generateId())
                .replace('{name}', item.name || '')
                .replace('{url}', item.url || '')
                .replace('{icon}', item.icon || '');
            
            const $item = $(itemHtml);

            if (isSub) {
                $item.find('.add-sub-menu-item').remove(); // Limit to 2 levels
            } else if (item.children && item.children.length) {
                item.children.forEach(subItem => {
                    const $subItem = renderMenuItem(subItem, true);
                    $item.find('.sub-menu-list').append($subItem);
                });
            }
            return $item;
        }

        function loadMenu() {
            try {
                const data = JSON.parse(menuDataTextarea.val() || '[]');
                menuList.empty();
                data.forEach(item => {
                    const $item = renderMenuItem(item);
                    menuList.append($item);
                });
            } catch (e) {
                console.error('Error parsing menu data:', e);
            }
        }

        function saveMenu() {
            const data = [];
            menuList.children('li').each(function() {
                const $item = $(this);
                const itemData = {
                    id: $item.data('id'),
                    name: $item.find('.menu-name').first().val(),
                    url: $item.find('.menu-url').first().val(),
                    icon: $item.find('.menu-icon').first().val(),
                    children: []
                };

                $item.find('.sub-menu-list').children('li').each(function() {
                    const $subItem = $(this);
                    itemData.children.push({
                        id: $subItem.data('id'),
                        name: $subItem.find('.menu-name').val(),
                        url: $subItem.find('.menu-url').val(),
                        icon: $subItem.find('.menu-icon').val()
                    });
                });
                data.push(itemData);
            });
            menuDataTextarea.val(JSON.stringify(data, null, 2));
        }

        $('#add-menu-item').on('click', function() {
            const $item = renderMenuItem({});
            menuList.append($item);
        });

        menuList.on('click', '.add-sub-menu-item', function() {
            const $subList = $(this).siblings('.sub-menu-list');
            const $subItem = renderMenuItem({}, true);
            $subList.append($subItem);
        });

        menuList.on('click', '.remove-menu-item', function() {
            $(this).closest('.list-group-item').remove();
        });

        $('form').on('submit', function() {
            saveMenu();
        });

        // Initial load
        loadMenu();
    });
    </script>
</body>
</html>
