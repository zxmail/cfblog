<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>CF-blog后台</title>
    <link rel="icon" type="image/x-icon" href="{{ &OPT.theme_github_path }}JustNews/admin/files/favicon.ico" />
	<link rel="shortcut icon" type="image/x-icon"  href="{{ &OPT.theme_github_path }}JustNews/admin/files/favicon.ico"/>
    <link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap.min.css">
    <link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap-select.min.css">
	<link rel="stylesheet" href="{{ &OPT.theme_github_path }}JustNews/files/fonts/fontawesome5pro-all.min.css">
	<link rel="stylesheet" type="text/css" href="{{ &OPT.theme_github_path }}JustNews/files/tinymce/skins/ui/oxide/skin.min.css">
	<link rel="stylesheet" type="text/css" href="{{ &OPT.theme_github_path }}JustNews/files/tinymce/skins/ui/oxide/content.min.css">
	<link rel="stylesheet" type="text/css" href="{{ &OPT.theme_github_path }}JustNews/files/tinymce/skins/content/default/content.min.css">
    <script src="{{ &OPT.theme_github_path }}JustNews/admin/files/jquery.min.js"></script>
    <script src="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap.min.js"></script>
    <script src="{{ &OPT.theme_github_path }}JustNews/admin/files/bootstrap-select.min.js"></script>
    <script src="{{ &OPT.theme_github_path }}JustNews/admin/files/defaults-zh_CN.min.js"></script>
	<style>
		.bootstrap-select>.dropdown-toggle {
		z-index:auto;
		}
		/* --- BEGIN: 新增的登录框样式 --- */
        #login-wrapper {
            position: fixed; /* 固定位置，覆盖在整个页面上 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(244, 247, 246, 0.95); /* 半透明背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* 确保在最上层 */
        }
        .login-container {
            width: 100%;
            max-width: 360px;
            padding: 40px;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            text-align: center;
        }
        .login-header {
            margin-bottom: 30px;
        }
        .login-header img {
            max-width: 80%;
            height: auto;
            max-height: 60px;
        }
        .login-header h1 {
            font-size: 24px;
            color: #333;
            margin: 0;
        }
        .login-form .form-group {
            margin-bottom: 20px;
        }
        /* .login-form .form-control is already defined by bootstrap */
        .login-form .btn-login {
            width: 100%;
            padding: 10px; /* Adjusted padding to match bootstrap button */
        }
        .login-form .footer-link {
            margin-top: 20px;
            text-align: right;
        }
        .login-form .footer-link a {
            color: #777;
            text-decoration: none;
            font-size: 14px;
        }
		/* --- END: 新增的登录框样式 --- */
	</style>
</head>
<body>

<div id="login-wrapper" style="display: none;">
    <div class="login-container">
        <div class="login-header">
            {{ #OPT.logo }}
                <img src="{{ &OPT.logo }}" alt="Logo">
            {{ /OPT.logo }}
            {{ ^OPT.logo }}
                {{ #OPT.siteName }}
                    <h1>{{ &OPT.siteName }}</h1>
                {{ /OPT.siteName }}
                {{ ^OPT.siteName }}
                    <h1>后台登录</h1>
                {{ /OPT.siteName }}
            {{ /OPT.logo }}
        </div>
        <form class="login-form" id="login-form">
            <div class="form-group">
                <input type="text" id="admin-username" class="form-control" placeholder="请输入用户名" required>
            </div>
            <div class="form-group">
                <input type="password" id="admin-password" class="form-control" placeholder="请输入密码" required>
            </div>
            <button type="submit" class="btn btn-primary btn-login">登录</button>
        </form>
        <div class="footer-link">
            <a href="/">&larr; 返回到博客首页</a>
        </div>
    </div>
</div>


<nav class="navbar navbar-default " role="navigation">
	<div class="container-fluid">
	<div>
		<ul id="myTab" class="nav nav-tabs">
			<li>
				<a href="/" >CF-blog</a>
			</li>
			<li>
				<a href="#list" data-toggle="tab">我的文章</a>
			</li>
			<li  class="active">
				<a href="#new" data-toggle="tab">新建</a>
			</li>
			<li>
				<a href="#config" data-toggle="tab">设置</a>
			</li>
            <li><a href="#comments-manager" data-toggle="tab">评论管理</a></li>
            <li><a href="#carousel-manager" data-toggle="tab">轮播管理</a></li>
			<li>
				<a href="#pub" data-toggle="tab">发布</a>
			</li>
            <li>
                <a href="#" id="logout-button">退出登录</a>
            </li>
		</ul>
	</div>
	</div>
</nav>
<div id="myTabContent" class="tab-content" style="padding-top: 60px;">
	<div class="tab-pane fade" id="list">
		<div class="container" >
			<table class="table  table-striped" id="articleList">
				  <tr><td>ID</td><td>标题</td><td>创建日期</td></tr>
			</table>
			<input type="hidden"  name="page" id="page" value='1'>
			<a id="loadmore" class="btn btn-default">加载更多...</a>
		</div>
	</div>
	<div class="tab-pane fade in active" id="new">
		<div class="container">
			<h3 id="labelNew">新增<span style="color: red;">*</span></h3>
			<form id="addNewForm"  class="form-inline" >
				<div class="form-group" style="width: 98%">
					<input type="hidden" class="form-control" name="id" id="id" >
					<input type="text" class="form-control" name="title" id="title" placeholder="标题" style="width: 100%;" required="true">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">特色图片</label>
					<input type="url" class="form-control" style="width: 400px;"  name="img" id="img" placeholder="" >
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">永久链接</label>
					<input type="text" class="form-control" name="link" id="link" placeholder="" required="true">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">创建日期<span style="color: red;">*</span></label>
					<input type="datetime-local" class="form-control" id="createDate" name="createDate" placeholder=""  required="true">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">分类<span style="color: red;">*</span></label>
					<select class="selectpicker" multiple name="category[]" id="category">
					</select>
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">标签</label>
					<input type="text" class="form-control" name="tags" id="tags" placeholder="标签1,标签2">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">权重</label>
					<input type="text" class="form-control" name="priority" id="priority" value='0.5' placeholder="权重">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">更新频率</label>
					    <select class="form-control" id="changefreq" name="changefreq">
						<option value="daily" selected  = "selected" >daily</option>
						<option value="hourly" >hourly</option>
						<option value="weekly" >weekly</option>
						<option value="monthly" >monthly</option>
						<option value="yearly" >yearly</option>
						<option value="never" >never</option>
						<option value="always" >always</option>
					    </select>
				</div>
					<a  tabindex="0"  role="button"  type="submit" id="btn_saveAddNew" class="btn btn-default" onclick="saveAddNew()">保存</a>

				<textarea id="content" name="content"></textarea>
			</form>
		</div>
	</div>

	<div class="tab-pane fade" id="config">

		<div class="container" >
			<form id="configForm" role="form" >
				<div class="form-group">
				    <label for="name">分类, 例:<code>["类别A","类别B","类别C","类别D"]</code></label>
					<textarea class="form-control" id="WidgetCategory" name="WidgetCategory" rows="3" placeholder='["分类A","分类B"]'></textarea>
				</div>

				<div class="form-group">
				    <label for="name">菜单, 例:<code>[{"title":"技术文章","url":"/category/技术文章"},{"title":"管理","url":"/admin"}]</code></label>
					<textarea class="form-control" id="WidgetMenu" name="WidgetMenu" rows="5"  placeholder='[
	{"title":"菜单A"	,"url":"/category/菜单A"},
	{"title":"菜单B"	,"url":"/category/菜单B"}
]'></textarea>
				</div>
				<div class="form-group">
				    <label for="name">其他链接, 例:<code>[{"title":"我的好友","url":"https://blog.gezhong.vip/"},{"title":"谷歌","url":"https://www.google.com/"}]</code></label>
					<textarea class="form-control" id="WidgetLink" name="WidgetLink" rows="5"  placeholder='[
	{"title":"好友"	,"url":"https://blog.gezhong.vip/"},
	{"title":"谷歌"	,"url":"https://www.google.com/"}
]'></textarea>
				</div>
				<a  tabindex="0"  role="button"  type="submit" id="btn_saveConfig" class="btn btn-default" onclick="saveConfig()">保存</a>
			</form>


			<form id="importForm" role="form" >
				<div class="form-group">
				    <label for="name">导出/导入</label>
					<textarea class="form-control" id="importJson" name="importJson" rows="3" placeholder='复制完整的导出json'></textarea>
				</div>

				<a  tabindex="0"  role="button"  type="submit" id="btn_import" class="btn btn-default" onclick="importBlog()">导入</a>
				<a  tabindex="0"  role="button"  type="submit" id="btn_export" class="btn btn-default"  href="/admin/export/" >导出</a>
			</form>
		</div>
	</div>

    <div class="tab-pane fade" id="comments-manager">
        <div class="container">
            <h3>评论管理</h3>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>文章 Slug</th>
                            <th>评论内容</th>
                            <th>评论时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="comments-list">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="carousel-manager">
        <div class="container">
            <h3>轮播海报管理</h3>
            <div class="jumbotron" style="padding: 20px; margin-top: 20px;">
                <h4>新增轮播图</h4>
                <form>
                    <div class="form-group">
                        <label for="imageUrl">图片URL</label>
                        <input type="text" class="form-control" id="imageUrl" placeholder="请输入图片的URL">
                    </div>
                    <div class="form-group">
                        <label for="linkUrl">链接URL</label>
                        <input type="text" class="form-control" id="linkUrl" placeholder="请输入点击图片后跳转的URL">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addCarousel()">添加</button>
                </form>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>图片预览</th>
                            <th>图片URL</th>
                            <th>链接URL</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="carousel-list">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

	<div class="tab-pane fade" id="pub">
		<div class="container" >
			<div class="jumbotron" >
				<p class="lead">
				由于前端使用缓存,以下操作需要发布:新建文章、发布文章、修改后台配置、修改workers配置</br>
				前端生效需要ctrl+F5 强制刷新
				</p>

				<a href="#" class="btn btn-default" onclick="publish()">发布</a>
			</div>
		</div>
	</div>
</div>

<script src="{{ &OPT.theme_github_path }}JustNews/files/tinymce/tinymce.min.js"></script>
<script src="{{ &OPT.theme_github_path }}JustNews/files/tinymce/langs/zh_CN.js"></script>
<script type="text/javascript">
	$(function() {
        // --- BEGIN: 登录逻辑 ---
        const loginWrapper = document.getElementById('login-wrapper');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('admin-username');
        const passwordInput = document.getElementById('admin-password');
        const logoutButton = document.getElementById('logout-button');

        // ==== 在这里设置您的后台用户名和密码 ====
        const ADMIN_USERNAME = "admin"; 
        const ADMIN_PASSWORD = "123456";

        // 登录表单提交事件
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault(); 
            const enteredUsername = usernameInput.value;
            const enteredPassword = passwordInput.value;
            if (enteredUsername === ADMIN_USERNAME && enteredPassword === ADMIN_PASSWORD) {
                // **核心修复：登录成功后，设置后端需要的cookie**
                document.cookie = "password=" + enteredPassword + ";path=/";
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                loginWrapper.style.display = 'none';
                // 登录成功后重新加载页面，确保所有后台请求都带上新cookie
                location.reload(); 
            } else {
                alert('用户名或密码错误！');
            }
        });

        // 退出登录按钮
        logoutButton.addEventListener('click', function(event) {
            event.preventDefault();
            sessionStorage.removeItem('isAdminLoggedIn');
            // 清除cookie
            document.cookie = "password=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            usernameInput.value = ''; 
            passwordInput.value = '';
            loginWrapper.style.display = 'flex';
        });

        // 页面加载时检查登录状态
        if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') {
            loginWrapper.style.display = 'flex';
        }
		// --- END: 登录逻辑 ---

		$('#myTab li:eq(0) 1').tab('show');
		var categoryJson = [];
		var menuJson = [];
		var linkJson = [];

		tinymce.init({
			selector: '#content',
			language: 'zh_CN',
			height: 640,
			plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking save table contextmenu directionality emoticons template paste textcolor',
			toolbar: 'insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons',
		});

		$('#createDate').val(new Date().toISOString().slice(0, 16));
		$('#WidgetCategory').val(JSON.stringify(categoryJson));
		$('#WidgetMenu').val(JSON.stringify(menuJson));
		$('#WidgetLink').val(JSON.stringify(linkJson));
		var category = $('#category');
		category.empty();
		for (var i = 0; i < categoryJson.length; i++) {
			category.append('<option id=' + categoryJson[i] + ' value=' + categoryJson[i] + '>' + categoryJson[i] + '</option>');
		}
        $('.selectpicker').selectpicker('refresh');
		$("#loadmore").click();
	});
    //加载文章列表
    $("#loadmore").click(function(){
        var page=$("#page").val();
        $.ajax({
            url:"/admin/getList/" + page + "/",
            type:'GET',
            dataType:"json",
            success:function(data){
                    tableContent="";
                    $.each(data,function(i){
                        var Info = data[i];
                        tableContent += '<tr><td>'+Info.id+'</td><td><a href="/admin/edit/'+Info.id+'/">'+Info.title+'</a></td><td>'+Info.createDate.replace("T","")+'</td></tr>';
                    })
                    $("#articleList").append(tableContent);
                    $("#page").val(++page);
            }
        });
    })
    //新建文章
    function saveAddNew(){
        if($('#title').val() == "" || $('#createDate').val() == "" || $('#category').val() == ""){
           alert("信息不全");
           return;
        }
        var postURL = "/admin/saveEdit/";
        if ($('#id').val() == "" || $('#id').val() == null)
            postURL=  "/admin/saveAddNew/";
        $.ajax({
            type: "POST",
            dataType: "json",
            url: postURL ,
			contentType: "application/json; charset=utf-8",
			data: JSON.stringify($("#addNewForm").serializeArray()),
            success: function (result) {
                if("msg" in result){
                  if ("id" in result){
                    $('#id').val(result.id);
                    $('#labelNew').text("编辑:"+result.id);
                  }
                  alert(result.msg);
                }else {
                  alert("失败");
                }
            }
        });
    }
    //保存设置
    function saveConfig(){
        if(!isJSON($('#WidgetCategory').val()) || !isJSON($('#WidgetMenu').val()) || !isJSON($('#WidgetLink').val())) {
            alert("JSON格式错误");
            return false;
        }
        $.ajax({
            type: "POST",
            dataType: "json",
			contentType: "application/json; charset=utf-8",
            url: "/admin/saveConfig/" ,
			data: JSON.stringify($("#configForm").serializeArray()),
            success: function (result) {
                alert(result.msg);
            }
        });
    }
    //导入json
    function importBlog(){
        if(!isJSON($('#importJson').val())) {
            alert("导入格式错误");
            return false;
        }
        $.ajax({
            type: "POST",
            dataType: "json",
			contentType: "application/json; charset=utf-8",
            url: "/admin/import/" ,
			data: JSON.stringify($("#importForm").serializeArray()),
            success: function (result) {
                alert(result.msg);
            }
        });
    }
    //发布
    function publish(){
        if (confirm("确定吗?发布将清理所有静态缓存,重新生成")==false){
            return false;
        }
        $.ajax({
            type: "POST",
            dataType: "json",
			contentType: "application/json; charset=utf-8",
            url: "/admin/publish/" ,
            success: function (result) {
                alert(result.msg);
            }
        });
    }
    function isJSON(str) {
        if (typeof str == 'string' && str.trim() !== '') {
            try {
                var obj=JSON.parse(str);
                return typeof obj == 'object' && obj;
            } catch(e) {
                return false;
            }
        }
        return false;
    }

    // --- BEGIN: 新增的评论和轮播管理JS函数 ---
    function loadComments() {
        $.ajax({ url: "/api/comments_all", type: 'GET', dataType: "json",
            success: function(comments) {
                var tbody = $('#comments-list');
                tbody.empty();
                $.each(comments, function(i, comment) {
                    var row = '<tr id="comment-' + comment.id + '"><td>' + comment.articleSlug + '</td><td>' + comment.content + '</td><td>' + new Date(comment.timestamp).toLocaleString() + '</td><td><button class="btn btn-danger btn-sm" onclick="deleteComment(\'' + comment.articleSlug + '\', \'' + comment.id + '\')">删除</button></td></tr>';
                    tbody.append(row);
                });
            }
        });
    }

    function deleteComment(articleSlug, commentId) {
        if (confirm('确定要删除这条评论吗？')) {
            $.ajax({ url: '/api/comments/' + articleSlug + '/' + commentId, type: 'DELETE',
                success: function() { $('#comment-' + commentId).remove(); },
                error: function() { alert('删除失败'); }
            });
        }
    }

    function loadCarousel() {
        $.ajax({ url: "/api/carousel", type: 'GET', dataType: "json",
            success: function(slides) {
                var tbody = $('#carousel-list');
                tbody.empty();
                $.each(slides, function(i, slide) {
                    var row = '<tr id="slide-' + slide.id + '"><td><img src="' + slide.imageUrl + '" alt="预览" style="max-width: 150px; height: auto;"></td><td>' + slide.imageUrl + '</td><td>' + slide.linkUrl + '</td><td><button class="btn btn-danger btn-sm" onclick="deleteCarousel(\'' + slide.id + '\')">删除</button></td></tr>';
                    tbody.append(row);
                });
            }
        });
    }

    function addCarousel() {
        var imageUrl = $('#imageUrl').val();
        var linkUrl = $('#linkUrl').val();
        if (!imageUrl || !linkUrl) { alert('图片URL和链接URL均不能为空！'); return; }
        $.ajax({
            url: "/api/carousel", type: 'POST', contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ imageUrl: imageUrl, linkUrl: linkUrl }),
            success: function() {
                loadCarousel();
                $('#imageUrl').val('');
                $('#linkUrl').val('');
            },
            error: function() { alert('添加失败'); }
        });
    }

    function deleteCarousel(slideId) {
        if (confirm('确定要删除这张轮播图吗？')) {
            $.ajax({ url: '/api/carousel/' + slideId, type: 'DELETE',
                success: function() { $('#slide-' + slideId).remove(); },
                error: function() { alert('删除失败'); }
            });
        }
    }
    
    // 当点击管理Tab时加载对应数据
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      if(e.target.hash == "#comments-manager"){
        loadComments();
      }
      if(e.target.hash == "#carousel-manager"){
        loadCarousel();
      }
    });
    // --- END: 新增的评论和轮播管理JS函数 ---
</script>

</body>
</html>
